version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: 'Block #1'
    task:
      jobs:
        - name: 'Job #1'
          commands:
            - checkout
            - echo $SEMAPHORE_OIDC_TOKEN
            - echo $SEMAPHORE_OIDC_TOKEN | awk -F '.' '{ print $1 }' | base64 --decode
            - echo $SEMAPHORE_OIDC_TOKEN | awk -F '.' '{ print $2 }' | base64 --decode || true
            - echo $SEMAPHORE_OIDC_TOKEN > /tmp/oidc_token
            - cat /tmp/oidc_token
            - gcloud --version
            - sudo apt-get update && sudo apt-get --only-upgrade -y install google-cloud-sdk-skaffold kubectl google-cloud-sdk-anthos-auth google-cloud-sdk-minikube google-cloud-sdk google-cloud-sdk-app-engine-grpc google-cloud-sdk-kind google-cloud-sdk-pubsub-emulator google-cloud-sdk-app-engine-go google-cloud-sdk-firestore-emulator google-cloud-sdk-cloud-build-local google-cloud-sdk-datastore-emulator google-cloud-sdk-kpt google-cloud-sdk-app-engine-python google-cloud-sdk-spanner-emulator google-cloud-sdk-cbt google-cloud-sdk-bigtable-emulator google-cloud-sdk-app-engine-python-extras google-cloud-sdk-datalab google-cloud-sdk-app-engine-java
            - export POOL_PATH="projects/525291099507/locations/global/workloadIdentityPools/semaphore-preprod/providers/rtx-semaphore-preprod"
            - export SERVICE_ACCOUNT="oidc-test-account@semaphore2-stg.iam.gserviceaccount.com"
            - gcloud iam workload-identity-pools create-cred-config $POOL_PATH --credential-source-file=/tmp/oidc_token --credential-source-type=text --output-file=/tmp/creds --service-account="$SERVICE_ACCOUNT"
            - cat /tmp/creds
            - gcloud auth login --brief --cred-file /tmp/creds
            - cat /tmp/creds
            - gcloud iam service-accounts get-iam-policy $SERVICE_ACCOUNT
